---
import BaseLayout from "../layouts/Layout.astro";
import Stripe from "stripe";

// Usa tu cliente anon para Stripe
import { supabase } from "../lib/supabaseClient";
// Y el cliente admin para orders
import { supabaseAdmin } from "../lib/supabaseAdminClient";

import InvoiceButton from "../components/InvoiceButton.jsx";

const stripe = new Stripe(import.meta.env.STRIPE_SECRET_KEY, {
  apiVersion: "2022-11-15",
});

const sessionId = Astro.url.searchParams.get("session_id")!;

// 1) Recupera la sesión de Stripe
let session = null;
try {
  session = await stripe.checkout.sessions.retrieve(sessionId, {
    expand: ["line_items.data.price.product"],
  });
} catch (err) {
  console.error("Error fetching Stripe session:", err);
}

// 2) Con el cliente ADMIN ignoramos RLS
const { data: dbOrder, error: dbError } = await supabaseAdmin
  .from("orders")
  .select("id, amount_total, invoice_url")
  .eq("checkout_session_id", sessionId)
  .maybeSingle();

if (dbError) console.error("Error fetch success page:", dbError);
const order = dbOrder || null;

// 3) Construye el nombre del producto
let productName = "";
if (session?.line_items?.data) {
  productName = session.line_items.data
    .map((li) => {
      const prod = (li.price as any).product as Stripe.Product;
      return prod?.name ?? li.description ?? "Artículo";
    })
    .join(", ");
}
---

<BaseLayout title="Gracias por tu compra">
  <div
    class="max-w-md mx-auto p-6 bg-white rounded shadow text-center space-y-4"
  >
    {
      session ? (
        <>
          <h1 class="text-2xl font-bold">¡Pago completado!</h1>
          <p>
            Has comprado: <strong>{productName}</strong>
            <br />
            <span>
              Importe: €
              {session.amount_total != null
                ? (session.amount_total / 100).toFixed(2)
                : "N/A"}
            </span>
          </p>

          {order ? (
            order.invoice_url ? (
              <a
                href={order.invoice_url}
                target="_blank"
                class="inline-block px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700"
              >
                Descargar factura
              </a>
            ) : (
              <InvoiceButton client:load orderId={order.id} />
            )
          ) : (
            <p class="text-red-600">
              No pudimos encontrar tu pedido en la base de datos.
            </p>
          )}
        </>
      ) : (
        <p class="text-red-600">No se pudo recuperar la información de pago.</p>
      )
    }
  </div>
</BaseLayout>
